# TestAntivirus

## Задание
Вы нашли на своем компьютере ранее неизвестный вирус и на virustotal его не определил ни один антивирус, вы полностью разочаровались в антивирусах и решили написать свою антивирусную программную утилиту.

У вас есть тело вируса ["Virus.bin"](https://cloud.mail.ru/public/8gKU/ELCWprct4) и файл с базой сигнатур ["main.cvd"](https://cloud.mail.ru/public/B43h/y6VS2TTpU)
 (доступ в файле "База сигнатур") популярного open-source антивируса. Но вот незадача, файл базы сигнатур имеет странный формат cvd.

Задание:

1. Cконвертировать имеющуюся базу сигнатур в пригодный вид для разработки своего решения. (Подсказка: файл, после некоторых манипуляций, станет обычным архивом).

2. Добавить сигнатуру вируса _"virus.bin"_ в сконвертированную базу имеющихся сигнатур.

3. Написать небольшой модуль на C/C++ с примитивным графическим интерфейсом, который будет принимать на вход файл, искать сигнатуру из базы сигнатур и выдавать результат заражен/не заражен.

На выполнение задания дается 48 часов.
Результаты выполнения задания, а так же пояснительную записку к заданию загружайте в свой репозиторий github.

## Решение поставленной задачи

### Определение формата базы сигнатур

* По подсказке в задании попробовал изменить расширение на _".rar"_, _".zip"_, _".7z"_ и открыть архиватором WinRar, т.к. он умеет открывать архивы с такими расширениями. Он не смог.
* Открыл в редакторе файл _"main.cvd"_
* Набрал в поисковике **ClamAV-VDB**
* Скачал и установил ["ClamWin"](http://ru.clamwin.com/). С помощью его утилиты **sigtool.exe** и команды ***unpack*** распаковал _"main.cvd"_ в ["main.mdb"](https://cloud.mail.ru/public/GN3N/RimYKCNGh).
* Открыл в редакторе и определил формат сигнатур:

	***Размер:MD5:ИмяВируса***

	***Размер:MD5:ИмяВируса***

	***...***

* Вычислил размер, MD5 _"Virus.bin"_ и с помощью редактора добавил в _"main.mdb"_.

### Алгоритм работы

* Прием пути к проверяемому файлу, вычисление его размера и MD5.
* Построчное считывание сигнатур с "main.mdb" и сравнение по размеру и MD5.
* Выводить пользователю процент проверенных сигнатур.
* Если вирус попытаться удалить.
* Уведомление пользователя о результатах.

### Реализация

* MSVC 2013
* C++/STL
* WinAPI/WinCrypto

### Системные требования

* CPU: 1 GHz
* RAM: 6 Mb
* HDD: 250 kb

### Проверено

Windows 7/8 (x86/x64).

### Описание приложения

Состоит из одного исполняемого файла: Win32Project1.exe. Файл базы вирусных сигнатур ***"main.mdb"*** должен быть в одном каталоге с приложением. 

### Руководство использования приложения

Смотреть ***"Help.docx"***.

### Описание классов

* ***App*** отвечает за GUI: выбор файла/запуск проверки/отображение в заголовке окна прогресса проверки/прерывание проверки/закрытие программы.
* ***FileScan*** выполняет проверку указанного пользователем файла.
* ***Thread*** инкапсулирует функции WinAPI для работы с потоком. Реализовал его, т.к. класс thread с С++11 еще полностью не освоил + с потоками на WinAPI можно использовать атрибуты безопасности, что является важно при разработке защитного ПО.
* ***AutoEvent*** инкапсулирует функции WinAPI для работы с событиями с автоматическим сбросом. Используется для корректного завершения потока проверки при отмене проверки.
* ***CriticalSection*** инкапсулирует функции WinAPI для работы с критической секцией. Используется в классе Thread для изменения и определения статуса потока: работает/не работает.
* ***DialogFile*** инкапсулирует функцию WinAPI выбора файла с помощью стандартного диалогового окна Windows.
* ***TextBox, Button*** используется для управления текстом контролов.
* ***WinApiException*** для обработки ошибок функций WinAPI.
* ***HandleThread и HandleEvent*** обертки для хранения дескриптора потока и события.
* ***HandleWinCryptoProvider и HandleWinCryptoHash*** обертки для хранения дескриптора криптографического провайдера, используется для вычисления MD5.
* ***HashMD5*** вычисляет MD5 данных.
* ***FileHash*** вычисляет хеш файла.
* ***ParamToScan*** структура, для передачи параметров классу FileScan.

### Диаграмма классов

Смотреть файл ***"ClassDiagram.png"***.

### Преимущества решения

Применяется абстракция, чтоб можно было расширять функционал. Например, добавить новый вид сканирования: ключ реестра или процесс. 

### Недостатки решения

1. Из-за абстракции и STL медленно сравнивает файл с сигнатурами. **В идеале ядро должно быть на чисто Си, в отдельной .dll**. 
2. Еще лучше для проверки использовать функцию _CreateProcess_ и установленный _ClamAv_, но тогда не удалось бы продемонстрировать свои навыки.

### Реально потраченное время

20 часов на проектирование, реализацию и отладку.
